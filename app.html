<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertex Trade | Professional Crypto Exchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; background-color: #0c111c; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        #loading-spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .iti { width: 100%; } .iti input, .iti input[type=tel], .iti input[type=text] { background-color: #0f172a; color: #e2e8f0; } .iti__country-list { background-color: #1e293b; border: 1px solid #334155; color: #e2e8f0; } .iti__country:hover, .iti--highlight { background-color: #334155; } .iti__divider { border-bottom-color: #334155; }
        .glass-card { background: rgba(25, 28, 41, 0.6); -webkit-backdrop-filter: blur(16px); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-[#0c111c] text-gray-200">
    <div id="loading-overlay" style="display: flex;" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div id="loading-spinner"></div>
    </div>

    <div id="auth-container" style="display: none;" class="min-h-screen w-full flex items-center justify-center bg-[#0c111c] p-4"></div>
    <div id="app-container" style="display: none;" class="h-screen w-screen flex flex-col"></div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        let currentUser = null;
        let currentAsset = null;
        let activeMarket = 'crypto';
        let tradingViewWidget = null;
        let portfolioPieChart = null;
        let phoneInput = null;
        const ADMIN_EMAIL = "usertest@gmail.com";
        const cryptoData = [ { id: 'BTC', name: 'Bitcoin', symbol: 'BINANCE:BTCUSDT', price: 68138.50, change: 1.25, volume: 45.2e9, high: 69500, low: 67100, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png', address: 'bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq' }, { id: 'ETH', name: 'Ethereum', symbol: 'BINANCE:ETHUSDT', price: 3557.18, change: -0.58, volume: 22.8e9, high: 3600, low: 3500, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1027.png', address: '0xDECAfF4eB0b284154868493581942414C401D352' }, { id: 'SOL', name: 'Solana', symbol: 'BINANCE:SOLUSDT', price: 152.88, change: 3.11, volume: 3.1e9, high: 155, low: 148, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/5426.png', address: 'So11111111111111111111111111111111111111112' }, { id: 'BNB', name: 'BNB', symbol: 'BINANCE:BNBUSDT', price: 610.43, change: 0.95, volume: 1.1e9, high: 619, low: 598, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1839.png', address: 'bnb136ns6lfw4s5g6cz8sfen7ts0y47axst2072c4G' }, { id: 'XRP', name: 'XRP', symbol: 'BINANCE:XRPUSDT', price: 0.5234, change: -1.12, volume: 1.2e9, high: 0.54, low: 0.51, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/52.png', address: 'rEb8TK3gBgk5oZkwcON3BCy2pD6xRjAMZp' }, { id: 'DOGE', name: 'Dogecoin', symbol: 'BINANCE:DOGEUSDT', price: 0.1572, change: 4.34, volume: 1.3e9, high: 0.16, low: 0.15, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/74.png', address: 'D8A4E2F1C5B7A9D3E6F8G0H1I2J3K4L5M6N7O8' }, { id: 'ADA', name: 'Cardano', symbol: 'BINANCE:ADAUSDT', price: 0.4621, change: 2.02, volume: 0.9e9, high: 0.47, low: 0.45, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/2010.png', address: 'addr1q8g8f5d2k2z2j2g8c4f5h4e3c2b1a0f9e8d7c6b5a4d3e2c1' }, { id: 'SHIB', name: 'Shiba Inu', symbol: 'COINBASE:SHIBUSD', price: 0.0000281, change: 5.15, volume: 0.8e9, high: 0.000029, low: 0.000027, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/5994.png', address: '0x95ad61b0a150d79219dcf64e1e6cc01f0b64c4ce' }, { id: 'DOT', name: 'Polkadot', symbol: 'BINANCE:DOTUSDT', price: 7.25, change: -0.50, volume: 0.5e9, high: 7.40, low: 7.10, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/6636.png', address: '13z2vH4V2Qo_g2j_g2j_g2j_g2j' }, { id: 'LINK', name: 'Chainlink', symbol: 'BINANCE:LINKUSDT', price: 18.50, change: 2.80, volume: 0.7e9, high: 19.00, low: 18.00, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1975.png', address: '0x514910771af9ca656af840dff83e8264ecf986ca' }, { id: 'LTC', name: 'Litecoin', symbol: 'BINANCE:LTCUSDT', price: 85.12, change: 1.10, volume: 0.6e9, high: 86.00, low: 84.00, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/2.png', address: 'ltc1qgqqq3qg3qg3qg3qg3qg3qg3qg3qgqqqg3qg3qg' }, { id: 'MATIC', name: 'Polygon', symbol: 'BINANCE:MATICUSDT', price: 0.725, change: -1.80, volume: 0.4e9, high: 0.75, low: 0.71, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/3890.png', address: '0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0' }, { id: 'UNI', name: 'Uniswap', symbol: 'BINANCE:UNIUSDT', price: 11.43, change: 3.50, volume: 0.3e9, high: 11.80, low: 11.00, icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/7083.png', address: '0x1f9840a85d5af5bf1d1762f925bdaddc4201f984' }];
        const stockData = [ { id: 'AAPL', name: 'Apple Inc.', symbol: 'NASDAQ:AAPL', price: 214.29, change: -1.04, volume: 52.2e6, high: 220.20, low: 212.00, icon: 'https://s3-symbol-logo.tradingview.com/apple.svg' }, { id: 'GOOGL', name: 'Alphabet Inc.', symbol: 'NASDAQ:GOOGL', price: 179.22, change: 1.85, volume: 25.1e6, high: 181.50, low: 178.75, icon: 'https://s3-symbol-logo.tradingview.com/alphabet.svg' }, { id: 'MSFT', name: 'Microsoft', symbol: 'NASDAQ:MSFT', price: 449.78, change: 1.21, volume: 22.3e6, high: 451.47, low: 445.80, icon: 'https://s3-symbol-logo.tradingview.com/microsoft.svg' }, { id: 'AMZN', name: 'Amazon.com', symbol: 'NASDAQ:AMZN', price: 189.08, change: -1.98, volume: 43.3e6, high: 191.90, low: 188.00, icon: 'https://s3-symbol-logo.tradingview.com/amazon.svg' }, { id: 'TSLA', name: 'Tesla, Inc.', symbol: 'NASDAQ:TSLA', price: 183.01, change: 3.85, volume: 102.7e6, high: 198.80, low: 182.10, icon: 'https://s3-symbol-logo.tradingview.com/tesla.svg' }, { id: 'NVDA', name: 'NVIDIA Corp', symbol: 'NASDAQ:NVDA', price: 131.88, change: 2.75, volume: 75.9e6, high: 135.90, low: 130.30, icon: 'https://s3-symbol-logo.tradingview.com/nvidia.svg' }, { id: 'META', name: 'Meta Platforms', symbol: 'NASDAQ:META', price: 498.50, change: -0.80, volume: 18.4e6, high: 505.00, low: 496.20, icon: 'https://s3-symbol-logo.tradingview.com/meta.svg' }, { id: 'JPM', name: 'JPMorgan Chase', symbol: 'NYSE:JPM', price: 198.20, change: 0.55, volume: 10.1e6, high: 200.10, low: 197.50, icon: 'https://s3-symbol-logo.tradingview.com/jpmorgan-chase.svg' }, { id: 'V', name: 'Visa Inc.', symbol: 'NYSE:V', price: 275.40, change: 0.90, volume: 7.8e6, high: 277.00, low: 274.10, icon: 'https://s3-symbol-logo.tradingview.com/visa.svg' }, { id: 'WMT', name: 'Walmart Inc.', symbol: 'NYSE:WMT', price: 67.50, change: -0.25, volume: 20.5e6, high: 68.00, low: 67.10, icon: 'https://s3-symbol-logo.tradingview.com/walmart.svg' }, { id: 'NFLX', name: 'Netflix Inc.', symbol: 'NASDAQ:NFLX', price: 686.12, change: 1.50, volume: 5.2e6, high: 690.00, low: 680.50, icon: 'https://s3-symbol-logo.tradingview.com/netflix.svg' }, { id: 'DIS', name: 'Walt Disney Co', symbol: 'NYSE:DIS', price: 102.50, change: 0.75, volume: 12.3e6, high: 103.20, low: 101.80, icon: 'https://s3-symbol-logo.tradingview.com/disney.svg' }];

        // --- CORE HELPERS ---
        const decodeJwt = (token) => { if(!token) return null; try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } };
        const fetchWithAuth = async (url, options = {}) => { const token = localStorage.getItem('authToken'); const headers = { 'Content-Type': 'application/json', ...options.headers }; if (token) headers['Authorization'] = `Bearer ${token}`; return fetch(url, { ...options, headers }); };
        
        // --- AUTHENTICATION & APP SHELL LOGIC ---
        const handleLogin = async (e) => { e.preventDefault(); const email = e.target.elements['login-email'].value; const password = e.target.elements['login-password'].value; const errorEl = document.getElementById('login-error'); errorEl.textContent = ''; document.getElementById('loading-overlay').style.display = 'flex'; try { const response = await fetchWithAuth('/login', { method: 'POST', body: JSON.stringify({ email, password }) }); if (!response.ok) throw new Error(await response.text() || 'Login failed'); localStorage.setItem('authToken', (await response.json()).token); main(); } catch (error) { errorEl.textContent = error.message; document.getElementById('loading-overlay').style.display = 'none'; } };
        const handleRegister = async (e) => { e.preventDefault(); const errorEl = document.getElementById('register-error'); errorEl.textContent = ''; const password = e.target.elements['register-password'].value; if (password !== e.target.elements['register-confirm-password'].value) { return errorEl.textContent = "Passwords do not match."; } if (!phoneInput || !phoneInput.isValidNumber()) { return errorEl.textContent = "Invalid phone number."; } const registrationData = { name: e.target.elements['register-name'].value, surname: e.target.elements['register-surname'].value, email: e.target.elements['register-email'].value, phoneNumber: phoneInput.getNumber(), password: password }; try { const response = await fetchWithAuth('/register', { method: 'POST', body: JSON.stringify(registrationData) }); if (!response.ok) throw new Error(await response.text() || 'Registration failed'); alert('Registration successful! Please sign in.'); renderLoginPage(); } catch (error) { errorEl.textContent = error.message; } };
        const handleLogout = () => { localStorage.removeItem('authToken'); currentUser = null; activeMarket = 'crypto'; if (tradingViewWidget) { try { tradingViewWidget.remove(); } catch (e) {} tradingViewWidget = null; } if (portfolioPieChart) { portfolioPieChart.destroy(); portfolioPieChart = null; } main(); };
        const renderLoginPage = () => { const container = document.getElementById('auth-container'); container.innerHTML = `<div class="w-full max-w-md bg-slate-800 border border-slate-700/50 rounded-2xl shadow-2xl p-8 space-y-8"><div class="text-center"><div class="flex justify-center items-center gap-3 mb-4"><svg class="w-10 h-10 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><h1 class="text-3xl font-bold text-white">Vertex Trade</h1></div><h2 class="text-2xl font-bold text-white">Sign in to your account</h2></div><form id="login-form" class="mt-8 space-y-6"><div class="rounded-md shadow-sm -space-y-px"><input name="login-email" type="email" autocomplete="email" required class="appearance-none rounded-t-md relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address"><input name="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-b-md relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password"></div><p id="login-error" class="text-red-500 text-sm text-center h-4"></p><button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Sign in</button></form><p class="text-sm text-center text-slate-400">Don't have an account? <button id="show-register" type="button" class="font-medium text-blue-500 hover:text-blue-400">Register here</button></p></div>`; document.getElementById('login-form')?.addEventListener('submit', handleLogin); document.getElementById('show-register')?.addEventListener('click', renderRegisterPage); document.getElementById('app-container').style.display = 'none'; container.style.display = 'flex'; document.getElementById('loading-overlay').style.display = 'none'; };
        const renderRegisterPage = () => { const container = document.getElementById('auth-container'); container.innerHTML = `<div class="w-full max-w-md bg-slate-800 border border-slate-700/50 rounded-2xl shadow-2xl p-8 space-y-8"><div class="text-center"><div class="flex justify-center items-center gap-3 mb-4"><svg class="w-10 h-10 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><h1 class="text-3xl font-bold text-white">Vertex Trade</h1></div><h2 class="text-2xl font-bold text-white">Create a new account</h2></div><form id="register-form" class="mt-8 space-y-6"><div class="rounded-md shadow-sm -space-y-px"><input name="register-name" type="text" autocomplete="given-name" required class="appearance-none rounded-t-md relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500" placeholder="Name"><input name="register-surname" type="text" autocomplete="family-name" required class="appearance-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500" placeholder="Surname"><input name="register-email" type="email" autocomplete="email" required class="appearance-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500" placeholder="Email address"><div class="relative"><input id="register-phone" type="tel" required class="appearance-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500"></div><input name="register-password" type="password" autocomplete="new-password" required class="appearance-none relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500" placeholder="Password (6+ characters)"><input name="register-confirm-password" type="password" autocomplete="new-password" required class="appearance-none rounded-b-md relative block w-full px-3 py-3 border border-slate-600 bg-slate-900 text-white placeholder-slate-500" placeholder="Confirm Password"></div><p id="register-error" class="text-red-500 text-sm text-center h-4"></p><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Create Account</button></form><p class="text-sm text-center text-slate-400">Already have an account? <button id="show-login" class="font-medium text-blue-500 hover:text-blue-400">Sign in</button></p></div>`; try { phoneInput = window.intlTelInput(document.querySelector("#register-phone"), { initialCountry: "auto", geoIpLookup: cb => cb(""), separateDialCode: true }); } catch (e) { console.error("Phone input failed", e); } document.getElementById('register-form')?.addEventListener('submit', handleRegister); document.getElementById('show-login')?.addEventListener('click', renderLoginPage); };
        const renderAppShell = () => { const container = document.getElementById('app-container'); container.innerHTML = `<header class="flex-shrink-0 bg-slate-900 border-b border-slate-700"><div class="flex items-center justify-between h-16 px-4 sm:px-6"><div class="flex items-center gap-3"><svg class="w-8 h-8 text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="text-xl font-bold text-white">Vertex Trade</span></div><div class="flex items-center gap-4"><button id="trade-nav-button" class="px-4 py-2 text-sm font-medium text-white rounded-md">Trade</button><button id="profile-nav-button" class="px-4 py-2 text-sm font-medium text-white rounded-md">My Profile</button><button id="admin-nav-button" style="display:none;" class="px-4 py-2 text-sm font-medium text-yellow-300 rounded-md">Admin Panel</button><span id="user-email-display" class="hidden sm:block text-sm text-slate-400"></span><button id="logout-button" class="px-4 py-2 text-sm font-medium text-white bg-red-600/80 hover:bg-red-600 rounded-md">Logout</button></div></div></header><main id="main-content" class="flex-1 flex flex-col overflow-hidden"><div id="dashboard-page" class="flex-1 flex-col overflow-hidden" style="display: none;"></div><div id="profile-page" class="flex-1 overflow-y-auto" style="display: none;"></div><div id="admin-page" class="flex-1 flex-col overflow-y-auto" style="display: none;"></div><div id="buy-sell-page" class="flex-1" style="display: none;"></div></main>`; document.getElementById('logout-button')?.addEventListener('click', handleLogout); document.getElementById('trade-nav-button')?.addEventListener('click', () => showPage('dashboard-page')); document.getElementById('profile-nav-button')?.addEventListener('click', () => showPage('profile-page')); document.getElementById('admin-nav-button')?.addEventListener('click', () => showPage('admin-page')); document.getElementById('user-email-display').textContent = currentUser.email; document.getElementById('admin-nav-button').style.display = currentUser.email === ADMIN_EMAIL ? 'block' : 'none'; document.getElementById('auth-container').style.display = 'none'; container.style.display = 'flex'; document.getElementById('loading-overlay').style.display = 'none'; };
        
        const showPage = (pageId) => {
            const pageContainer = document.getElementById(pageId);
            if (!pageContainer) return;
            ['dashboard-page', 'profile-page', 'admin-page', 'buy-sell-page'].forEach(id => { document.getElementById(id).style.display = 'none'; });
            pageContainer.style.display = 'flex';
            document.getElementById('trade-nav-button')?.classList.toggle('bg-blue-600', pageId === 'dashboard-page' || pageId === 'buy-sell-page');
            document.getElementById('profile-nav-button')?.classList.toggle('bg-blue-600', pageId === 'profile-page');
            document.getElementById('admin-nav-button')?.classList.toggle('bg-blue-600', pageId === 'admin-page');
            if (pageId === 'dashboard-page') renderDashboardPage();
            if (pageId === 'profile-page') renderProfilePage();
            if (pageId === 'admin-page') renderAdminPage();
        };

        // --- DASHBOARD PAGE ---
        const renderDashboardPage = () => { const container = document.getElementById('dashboard-page'); if (container.innerHTML === '') { container.innerHTML = `<div class="flex-1 flex overflow-hidden"><div class="w-[280px] flex-shrink-0 border-r border-slate-700 flex flex-col bg-slate-900"><div class="p-2 border-b border-slate-700 flex items-center gap-2"><button id="crypto-market-btn" class="flex-1 px-3 py-1 text-sm rounded-md">Crypto</button><button id="stock-market-btn" class="flex-1 px-3 py-1 text-sm rounded-md">Stocks</button></div><div id="market-list" class="flex-1 overflow-y-auto"></div></div><div class="flex-1 flex flex-col bg-[#161a25]"><div id="chart-header" class="p-4 border-b border-slate-700"></div><div class="flex-1 relative"><div id="main-chart-container" class="absolute inset-0"></div></div><div id="order-forms-container" class="bg-slate-900/50 border-t border-slate-700 p-4"></div></div><div class="w-[300px] flex-shrink-0 border-l border-slate-700 flex flex-col bg-slate-900"><div id="order-book-container" class="flex-1 flex flex-col overflow-hidden"></div><div id="trade-history-container" class="h-1/3 flex flex-col border-t border-slate-700"></div></div></div>`; document.getElementById('crypto-market-btn')?.addEventListener('click', () => switchMarket('crypto')); document.getElementById('stock-market-btn')?.addEventListener('click', () => switchMarket('stocks')); } switchMarket(activeMarket); };
        const switchMarket = (marketType) => { activeMarket = marketType; const data = activeMarket === 'crypto' ? cryptoData : stockData; if (!currentAsset || (activeMarket === 'crypto' && !cryptoData.find(c=>c.id === currentAsset.id)) || (activeMarket === 'stocks' && !stockData.find(c=>c.id === currentAsset.id))) { currentAsset = data[0]; } document.getElementById('crypto-market-btn')?.classList.toggle('bg-blue-600', activeMarket === 'crypto'); document.getElementById('stock-market-btn')?.classList.toggle('bg-blue-600', activeMarket === 'stocks'); selectAsset(currentAsset.id); };
        const selectAsset = (assetId) => { const data = activeMarket === 'crypto' ? cryptoData : stockData; const asset = data.find(c => c.id === assetId); if (!asset) return; currentAsset = asset; buildMarketList(); renderChartHeader(); renderOrderForms(); renderOrderBook(); renderTradeHistory(); if (!tradingViewWidget) { setTimeout(() => { try { tradingViewWidget = new TradingView.widget({ autosize: true, symbol: currentAsset.symbol, interval: "D", theme: "dark", container_id: "main-chart-container", disabled_features: ["use_localstorage_for_settings"] }); } catch(e) { console.error("TradingView failed", e); } }, 100); } else { try { tradingViewWidget.chart().setSymbol(currentAsset.symbol); } catch(e) {} } };
        const buildMarketList = () => { const listEl = document.getElementById('market-list'); const data = activeMarket === 'crypto' ? cryptoData : stockData; listEl.innerHTML = data.map(asset => `<div class="market-item p-3 cursor-pointer transition-colors duration-200 border-b border-slate-700/50 ${currentAsset.id === asset.id ? 'bg-blue-600/20' : ''}" data-asset-id="${asset.id}"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><img src="${asset.icon}" alt="${asset.name}" class="w-7 h-7 rounded-full"/><p class="font-semibold text-white text-sm">${asset.id}</p></div><div class="text-right"><p class="text-sm font-medium ${asset.change >= 0 ? 'text-green-400' : 'text-red-400'}">${asset.change > 0 ? '+' : ''}${asset.change.toFixed(2)}%</p><p class="text-sm text-slate-400 mt-1">$${asset.price.toLocaleString()}</p></div></div></div>`).join(''); document.querySelectorAll('.market-item').forEach(item => item.addEventListener('click', (e) => selectAsset(e.currentTarget.dataset.assetId)));};
        const renderChartHeader = () => { if (!currentAsset) return; document.getElementById('chart-header').innerHTML = `<div class="flex flex-wrap items-center gap-x-6 gap-y-2"><div class="flex items-center gap-3"><img src="${currentAsset.icon}" alt="${currentAsset.name}" class="w-9 h-9 rounded-full" /><div><h1 class="text-xl font-bold text-white">${currentAsset.name} <span class="text-slate-400">${currentAsset.id}</span></h1></div></div><p class="text-xl font-semibold text-white">$${currentAsset.price.toLocaleString()}</p><div><p class="text-xs text-slate-400">24h Change</p><p class="text-sm font-medium ${currentAsset.change >= 0 ? 'text-green-400' : 'text-red-400'}">${currentAsset.change > 0 ? '+' : ''}${currentAsset.change.toFixed(2)}%</p></div><div><p class="text-xs text-slate-400">24h High</p><p class="text-sm font-medium text-white">${currentAsset.high.toLocaleString()}</p></div><div><p class="text-xs text-slate-400">24h Low</p><p class="text-sm font-medium text-white">${currentAsset.low.toLocaleString()}</p></div></div>`; };
        const renderOrderForms = () => { document.getElementById('order-forms-container').innerHTML = `<div class="grid grid-cols-2 gap-6"><div><div class="flex justify-between items-center mb-2"><span class="font-semibold text-white">Buy ${currentAsset.id}</span><span class="text-sm text-slate-400">Balance: $10,000.00</span></div><button id="buy-button" class="w-full bg-green-600 hover:bg-green-700 rounded p-2 text-sm font-semibold transition-colors">Buy / Deposit</button></div><div><div class="flex justify-between items-center mb-2"><span class="font-semibold text-white">Sell ${currentAsset.id}</span><span class="text-sm text-slate-400">Balance: 0.00 ${currentAsset.id}</span></div><button id="sell-button" class="w-full bg-red-600 hover:bg-red-700 rounded p-2 text-sm font-semibold transition-colors">Sell / Withdraw</button></div></div>`; document.getElementById('buy-button')?.addEventListener('click', () => renderBuyPage(currentAsset)); document.getElementById('sell-button')?.addEventListener('click', () => renderSellPage(currentAsset)); };
        const generateDummyData = (price, count, isBids) => { let d=[];let p=isBids?price-price*Math.random()*.001:price+price*Math.random()*.001;for(let i=0;i<count;i++){p+=isBids?-Math.random()*.1:Math.random()*.1;d.push({price:p,amount:Math.random()*2})}return d.sort((a,b)=>isBids?b.price-a.price:a.price-b.price)};
        const renderOrderBook = () => { const container = document.getElementById('order-book-container'); container.innerHTML = `<div class="p-2 border-b border-slate-700"><h3 class="text-base font-semibold text-white px-2">Order Book</h3></div><div class="grid grid-cols-3 gap-2 text-xs text-slate-400 p-2 border-b border-slate-700/50"><span>Price(USD)</span><span class="text-right">Amount(${currentAsset.id})</span><span class="text-right">Total</span></div><div class="flex-1 flex flex-col overflow-hidden"><div id="order-book-asks" class="flex-1 overflow-y-auto relative"></div><div class="p-2 text-center text-lg font-semibold border-y border-slate-700 ${currentAsset.change >= 0 ? 'text-green-400' : 'text-red-400'}">${currentAsset.price.toLocaleString()}</div><div id="order-book-bids" class="flex-1 overflow-y-auto relative"></div></div>`; generateDummyData(currentAsset.price, 20, false).forEach(ask => document.getElementById('order-book-asks').innerHTML += `<div class="relative grid grid-cols-3 gap-2 text-xs p-1 hover:bg-slate-700/50"><div class="absolute top-0 bottom-0 right-0 bg-red-500/10" style="width: ${Math.random()*100}%"></div><span class="text-red-400 z-10">${ask.price.toFixed(2)}</span><span class="text-right z-10">${ask.amount.toFixed(4)}</span><span class="text-right z-10">${(ask.price*ask.amount).toFixed(2)}</span></div>`); generateDummyData(currentAsset.price, 20, true).forEach(bid => document.getElementById('order-book-bids').innerHTML += `<div class="relative grid grid-cols-3 gap-2 text-xs p-1 hover:bg-slate-700/50"><div class="absolute top-0 bottom-0 right-0 bg-green-500/10" style="width: ${Math.random()*100}%"></div><span class="text-green-400 z-10">${bid.price.toFixed(2)}</span><span class="text-right z-10">${bid.amount.toFixed(4)}</span><span class="text-right z-10">${(bid.price*bid.amount).toFixed(2)}</span></div>`);};
        const renderTradeHistory = () => { const container = document.getElementById('trade-history-container'); container.innerHTML = `<div class="p-2 border-b border-slate-700"><h3 class="text-base font-semibold text-white px-2">Market Trades</h3></div><div class="grid grid-cols-3 gap-2 text-xs text-slate-400 p-2 border-b border-slate-700/50"><span>Price(USD)</span><span class="text-right">Amount(${currentAsset.id})</span><span class="text-right">Time</span></div><div id="trade-history-list" class="flex-1 overflow-y-auto p-2"></div>`; const generateTrades = (price, count) => { let d=[];for(let i=0;i<count;i++){d.push({price:price+(Math.random()-.5)*.5,amount:Math.random(),time:new Date(Date.now()-Math.random()*6e4).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'}),type:Math.random()>.5?'buy':'sell'})}return d}; generateTrades(currentAsset.price, 30).forEach(trade => document.getElementById('trade-history-list').innerHTML += `<div class="grid grid-cols-3 gap-2 text-xs py-1"><span class="${trade.type === 'buy' ? 'text-green-400' : 'text-red-400'}">${trade.price.toFixed(2)}</span><span class="text-right">${trade.amount.toFixed(4)}</span><span class="text-right text-slate-500">${trade.time}</span></div>`);};
        const renderBuyPage = (asset) => { const page = document.getElementById('buy-sell-page'); showPage('buy-sell-page'); page.innerHTML = `<div class="flex items-center justify-center w-full h-full bg-gradient-to-br from-[#161a25] to-[#0c111c] p-4"><div class="w-full max-w-2xl glass-card rounded-2xl shadow-xl p-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Deposit ${asset.name} (${asset.id})</h2><button id="back-to-trade-btn" class="text-slate-400 hover:text-white transition-colors">&#x2190; Back to Trade</button></div><div class="flex flex-col md:flex-row gap-8 items-center"><div id="qrcode-container" class="p-4 bg-white rounded-lg"></div><div class="flex-1"><p class="text-slate-400 mb-2">Send only ${asset.name} (${asset.id}) to this deposit address.</p><div class="bg-slate-900 p-3 rounded-lg"><label class="text-xs text-slate-500">${asset.id} Deposit Address</label><p class="text-white font-mono break-words mt-1">${asset.address || 'N/A for stocks'}</p></div><p class="text-yellow-400 text-xs mt-4">This is a demo address. Do not send real funds.</p></div></div></div></div>`; if(asset.address) { const qr = qrcode(0, 'M'); qr.addData(asset.address); qr.make(); document.getElementById('qrcode-container').innerHTML = qr.createImgTag(5, 4); } else { document.getElementById('qrcode-container').innerHTML = '<p class="text-xs p-4">QR not available for stocks</p>'; } document.getElementById('back-to-trade-btn')?.addEventListener('click', () => showPage('dashboard-page')); };
        const renderSellPage = (asset) => { const page = document.getElementById('buy-sell-page'); showPage('buy-sell-page'); page.innerHTML = `<div class="flex items-center justify-center w-full h-full bg-gradient-to-br from-[#161a25] to-[#0c111c] p-4"><div class="w-full max-w-2xl glass-card rounded-2xl shadow-xl p-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Sell / Withdraw ${asset.name} (${asset.id})</h2><button id="back-to-trade-btn" class="text-slate-400 hover:text-white transition-colors">&#x2190; Back to Trade</button></div><div class="space-y-4"><div class="flex items-end gap-4"> <div class="flex-1"><label for="sell-amount-coin" class="text-sm text-slate-400">Amount to Sell</label><input id="sell-amount-coin" type="number" step="any" min="0" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded p-2 text-lg h-12" placeholder="0.00"></div> <div class="text-xl font-bold text-slate-400 pb-3">${asset.id}</div></div> <div class="flex items-end gap-4"><div class="flex-1"><label for="sell-amount-usd" class="text-sm text-slate-400">You Receive (approx.)</label><input id="sell-amount-usd" type="text" readonly class="mt-1 w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-lg h-12"></div><div class="text-xl font-bold text-slate-400 pb-3">USD</div></div><div><label for="withdraw-address" class="text-sm text-slate-400">Withdrawal Address</label><input id="withdraw-address" type="text" class="mt-1 w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm h-10"></div><button class="w-full bg-red-600/80 hover:bg-red-600 rounded p-2.5 text-sm font-semibold transition-colors mt-4">Withdraw ${asset.id}</button><p class="text-yellow-400 text-xs mt-4 text-center">This is a UI mockup. Withdrawals are not functional.</p></div></div></div>`; document.getElementById('back-to-trade-btn')?.addEventListener('click', () => showPage('dashboard-page')); const sellInput = document.getElementById('sell-amount-coin'); const usdInput = document.getElementById('sell-amount-usd'); sellInput?.addEventListener('input', (e) => { const usdValue = parseFloat(e.target.value) * asset.price; usdInput.value = isNaN(usdValue) ? '0.00' : usdValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }); };
        
        // --- PROFILE & ADMIN PAGES ---
        const renderProfilePage = async () => { const container = document.getElementById('profile-page'); container.innerHTML = `<div class="p-8 flex justify-center"><div id="loading-spinner"></div></div>`; if (portfolioPieChart) portfolioPieChart.destroy(); try { const response = await fetchWithAuth(`/api/portfolio/${currentUser.userId}`); if (!response.ok) throw new Error('Could not fetch portfolio data.'); const data = await response.json(); const assets = (typeof data.assets === 'string' ? JSON.parse(data.assets) : data.assets) || []; let totalValue = 0; const allAssetsData = [...cryptoData, ...stockData]; const processedAssets = assets.map(asset => { const assetInfo = allAssetsData.find(c => c.id === asset.id); const value = parseFloat(asset.amount) * (assetInfo ? assetInfo.price : 0); totalValue += value; const type = cryptoData.some(c => c.id === asset.id) ? 'crypto' : 'stock'; return { ...asset, ...assetInfo, value, type }; }).sort((a, b) => b.value - a.value); const cryptoAssets = processedAssets.filter(a => a.type === 'crypto'); const stockAssets = processedAssets.filter(a => a.type === 'stock'); const registrationDate = new Date(data.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }); container.innerHTML = `<div class="w-full mx-auto max-w-7xl p-8"><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8"><h1 class="text-3xl font-bold text-white">My Profile & Portfolio</h1><div class="text-left sm:text-right mt-2 sm:mt-0"><p class="text-sm text-slate-400">Total Portfolio Value</p><p class="text-3xl font-bold text-green-400">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8"><div class="lg:col-span-1 bg-slate-800 rounded-lg shadow-xl p-6"><h2 class="text-xl font-semibold text-white mb-4">User Details</h2><div class="space-y-3 text-sm"><p><span class="font-semibold text-slate-400">Name:</span> <span class="text-white">${currentUser.name}</span></p><p><span class="font-semibold text-slate-400">Email:</span> <span class="text-white">${currentUser.email}</span></p><p><span class="font-semibold text-slate-400">Member Since:</span> <span class="text-white">${registrationDate}</span></p></div></div><div class="lg:col-span-2 bg-slate-800 rounded-lg shadow-xl p-6"><h2 class="text-xl font-semibold text-white mb-4">Asset Allocation</h2><div class="h-64 relative flex items-center justify-center"><canvas id="portfolio-pie-chart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col"><h2 class="text-xl font-semibold text-white mb-4">Cryptocurrency Assets</h2><div class="space-y-4 flex-1 overflow-y-auto pr-2">${cryptoAssets.length > 0 ? cryptoAssets.map(asset => `<div class="flex items-center justify-between bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center gap-4"><img src="${asset.icon}" alt="${asset.id}" class="w-8 h-8 rounded-full"/><div class="flex-grow"><p class="font-semibold text-white">${asset.name}</p><p class="text-xs text-slate-400">${asset.id}</p></div></div><div class="text-right"><p class="font-semibold text-white">$${asset.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p><p class="text-xs text-slate-400">${parseFloat(asset.amount).toFixed(6)} ${asset.id}</p></div></div>`).join('') : '<p class="text-slate-400 text-center py-8">No cryptocurrency assets.</p>'}</div></div><div class="bg-slate-800 rounded-lg shadow-xl p-6 flex flex-col"><h2 class="text-xl font-semibold text-white mb-4">Stock Assets</h2><div class="space-y-4 flex-1 overflow-y-auto pr-2">${stockAssets.length > 0 ? stockAssets.map(asset => `<div class="flex items-center justify-between bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center gap-4"><img src="${asset.icon}" alt="${asset.id}" class="w-8 h-8 rounded-full"/><div class="flex-grow"><p class="font-semibold text-white">${asset.name}</p><p class="text-xs text-slate-400">${asset.id}</p></div></div><div class="text-right"><p class="font-semibold text-white">$${asset.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p><p class="text-xs text-slate-400">${parseFloat(asset.amount).toFixed(2)} Shares</p></div></div>`).join('') : '<p class="text-slate-400 text-center py-8">No stock assets.</p>'}</div></div></div></div>`; const chartCtx = document.getElementById('portfolio-pie-chart')?.getContext('2d'); if (chartCtx && processedAssets.length > 0) { portfolioPieChart = new Chart(chartCtx, { type: 'doughnut', data: { labels: processedAssets.map(a => a.name), datasets: [{ data: processedAssets.map(a => a.value), backgroundColor: ['#3b82f6','#ef4444','#f97316','#8b5cf6','#22c55e','#eab308','#06b6d4','#ec4899'], borderColor: '#1e293b', borderWidth: 4, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => { const value = ctx.parsed; const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(2) : 0; return `${ctx.label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`; } } } }, cutout: '70%' } }); } else if (chartCtx) { chartCtx.canvas.parentElement.innerHTML = `<div class="text-center text-slate-500 flex flex-col items-center justify-center h-full"><svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p>No assets to display chart.</p></div>`; } } catch (e) { container.innerHTML = `<p class="p-8 text-red-400 text-center">Error: ${e.message}</p>`; }};
        const renderAdminPage = async () => { const container = document.getElementById('admin-page'); container.innerHTML = `<div class="p-8 flex-1 flex flex-col overflow-y-auto"><div class="flex flex-col h-full gap-8"><h1 class="text-3xl font-bold text-white">Admin Panel</h1><div class="bg-slate-800 rounded-lg p-6 shadow-xl"><h2 class="text-xl font-semibold text-white mb-4">Add Funds to User Portfolio</h2><form id="add-funds-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div><label for="fund-user-id" class="text-sm text-slate-400">User ID</label><input id="fund-user-id" type="number" placeholder="e.g., 1" required class="mt-1 w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm h-10"></div><div><label for="fund-coin-id" class="text-sm text-slate-400">Asset</label><select id="fund-coin-id" required class="mt-1 w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm h-10"></select></div><div><label for="fund-amount-usd" class="text-sm text-slate-400">Amount (USD)</label><input id="fund-amount-usd" type="number" step="0.01" placeholder="e.g., 500.00" required class="mt-1 w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm h-10"></div><button type="submit" class="bg-blue-600 hover:bg-blue-700 rounded p-2 text-sm font-semibold h-10">Add Funds</button></form><p id="add-funds-feedback" class="text-green-400 text-sm mt-3 h-4"></p></div><div class="bg-slate-800 rounded-lg flex-1 flex flex-col overflow-hidden shadow-xl"><div class="border-b border-slate-700 p-6"><h2 class="text-xl font-semibold text-white">Registered Users</h2></div><div id="admin-user-list" class="flex-1 overflow-y-auto"><div id="loading-spinner" class="mx-auto mt-8"></div></div></div></div></div>`; const handleAddFunds = async (e) => { e.preventDefault(); const feedbackEl = document.getElementById('add-funds-feedback'); feedbackEl.textContent = 'Processing...'; const userId = document.getElementById('fund-user-id').value; const coinId = document.getElementById('fund-coin-id').value; const amountUSD = document.getElementById('fund-amount-usd').value; try { const response = await fetchWithAuth('/api/portfolio/add-funds', { method: 'POST', body: JSON.stringify({ userId, coinId, amountUSD }) }); if (!response.ok) throw new Error(await response.text()); feedbackEl.textContent = 'Funds added successfully!'; e.target.reset(); renderAdminPage(); } catch (error) { feedbackEl.textContent = `Error: ${error.message}`; feedbackEl.classList.add('text-red-400'); } finally { setTimeout(() => { feedbackEl.textContent = ''; feedbackEl.classList.remove('text-red-400'); }, 5000); } }; document.getElementById('add-funds-form')?.addEventListener('submit', handleAddFunds); const fundCoinSelect = document.getElementById('fund-coin-id'); if(fundCoinSelect){ const cryptoOptions = cryptoData.map(c => `<option value="${c.id}">${c.name} (${c.id})</option>`).join(''); const stockOptions = stockData.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join(''); fundCoinSelect.innerHTML = `<optgroup label="Cryptocurrencies">${cryptoOptions}</optgroup><optgroup label="Stocks">${stockOptions}</optgroup>`;} try { const response = await fetchWithAuth('/users'); if (!response.ok) throw new Error('Failed to load users.'); const users = await response.json(); const allAssetsData = [...cryptoData, ...stockData]; document.getElementById('admin-user-list').innerHTML = `<table class="w-full text-sm text-left text-slate-300"><thead class="text-xs text-slate-400 uppercase bg-slate-900/50"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Name</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">Phone</th><th class="px-6 py-3">Joined</th><th class="px-6 py-3">Portfolio</th><th class="px-6 py-3 text-right">Total Value</th></tr></thead><tbody>${users.map(user => { const userAssets = (user.assets && typeof user.assets === 'string') ? JSON.parse(user.assets) : (user.assets || []); let totalValue = 0; const portfolioIcons = userAssets.map(asset => { const assetInfo = allAssetsData.find(c => c.id === asset.id); if (assetInfo) { totalValue += parseFloat(asset.amount) * assetInfo.price; return `<img src="${assetInfo.icon}" alt="${assetInfo.id}" class="w-5 h-5 rounded-full" title="${parseFloat(asset.amount).toFixed(4)} ${assetInfo.id}">`; } return ''; }).join(''); return `<tr class="border-b border-slate-700 hover:bg-slate-700/50"><td class="px-6 py-4 font-medium">${user.id}</td><td class="px-6 py-4 whitespace-nowrap">${user.name} ${user.surname}</td><td class="px-6 py-4">${user.email}</td><td class="px-6 py-4">${user.phone_number}</td><td class="px-6 py-4 whitespace-nowrap">${new Date(user.created_at).toLocaleDateString()}</td><td class="px-6 py-4"><div class="flex items-center gap-1.5">${portfolioIcons || '<span class="text-xs text-slate-500">Empty</span>'}</div></td><td class="px-6 py-4 text-right font-mono text-green-400">$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`; }).join('')}</tbody></table>`; } catch (e) { document.getElementById('admin-user-list').innerHTML = `<p class="p-8 text-red-400 text-center">Error: ${e.message}</p>`; }};

        // --- MAIN APP ENTRY POINT ---
        const main = () => {
            currentUser = decodeJwt(localStorage.getItem('authToken'));
            if (currentUser && currentUser.userId) {
                renderAppShell();
                showPage('dashboard-page');
            } else {
                renderLoginPage();
            }
        };

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
